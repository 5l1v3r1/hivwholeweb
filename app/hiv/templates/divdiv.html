{% extends "plots.html" %}
{% block head_end %}
{{ super() }}
<script>
 function get_tmax(data) {
  var tmax = 0;
  for (i = 0; i < data.dg.length; i++) {
    if (data.dg[i][0] > tmax) {
     tmax = data.dg[i][0];
    }
  }
  for (i = 0; i < data.ds.length; i++) {
    if (data.ds[i][0] > tmax) {
     tmax = data.ds[i][0];
    }
  }
  return tmax;
 }

 function get_ymax(data) {
  var ymax = data[0][1];
  for (i = 1; i < data.length; i++) {
    if (data[i][1] > ymax) {
     ymax = data[i][1];
    }
  }
  return ymax;
 }

 function get_ymin(data) {
  var ymin = data[0][1];
  for (i = 1; i < data.length; i++) {
    if (data[i][1] < ymin) {
     ymin = data[i][1];
    }
  }
  return ymin;
 }

 function load_single(id, pname, fragment) {
  d3.xhr("/divdiv/")
   .header("Content-Type", "application/json")
   .post(
     JSON.stringify({patient: pname, fragment: fragment}),
     function(error, request) {
      var data = JSON.parse(request.responseText);
      update(data.data, id);
     }
  );
 }

 function update(data, id) {

  var margin = {top: 60, right: 60, bottom: 50, left: 80},
      width = 500 - margin.left - margin.right,
      height = 500 - margin.top - margin.bottom;

  var tmax = get_tmax(data);
  var dgmax = get_ymax(data.dg);
  var dgmin = get_ymin(data.dg);
  var dsmax = get_ymax(data.ds);
  var dsmin = get_ymin(data.ds);

  var y_dg = d3.scale.log()
       .domain([0.9 * dgmin, 1.1 * dgmax])
       .range([height, 0]);

  var y_ds = d3.scale.log()
       .domain([0.9 * dsmin, 1.1 * dsmax])
       .range([height, 0]);
  
  var x = d3.scale.linear()
       .domain([0, 1.1 * tmax])
       .range([0, width]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");
  
  var yAxis_dg = d3.svg.axis()
      .scale(y_dg)
      .orient("left");

  var yAxis_ds = d3.svg.axis()
      .scale(y_ds)
      .orient("right");

  var chart_ext = d3.select("."+id)
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.bottom + margin.top);

  var chart = chart_ext.append("g")
       .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  chart.append("g")
       .attr("class", "d3-axis")
       .attr("transform", "translate(0," + height + ")")
       .call(xAxis)
       .append("text")
       .attr("x", width / 2)
       .attr("y", 40)
       .style("text-anchor", "middle")
       .text("Time from infection [days]");
   
  chart.append("g")
       .attr("class", "d3-axis")
       .call(yAxis_dg)
       .append("text")
       .attr("transform", "rotate(-90)")
       .attr("dy", "-4.5em")
       .attr("x", -height / 2)
       .style("text-anchor", "middle")
       .text("Divergence");

  chart.append("g")
       .attr("class", "d3-axis")
       .attr("transform", "translate(" + width + " ,0)")
       .call(yAxis_ds)
       .append("text")
       .attr("transform", "rotate(-90)")
       .attr("dy", "4em")
       .attr("x", -height / 2)
       .style("text-anchor", "middle")
       .text("Diversity");

  chart.append("g")
       .attr("class", "circles DG")
       .selectAll()
       .data(data.dg)
       .enter()
       .append("circle")
       .attr("class", "circle")
       .attr("cx", function(d) { return x(d[0]); })
       .attr("cy", function(d) { return y_dg(d[1]); })
       .attr("r", 3);

  chart.append("g")
       .attr("class", "circles DS")
       .selectAll()
       .data(data.ds)
       .enter()
       .append("rect")
       .attr("class", "rect")
       .attr("x", function(d) { return x(d[0]) - 3; })
       .attr("y", function(d) { return y_ds(d[1]) - 3; })
       .attr("width", 6)
       .attr("height", 6)
       .attr("style", "fill:steelblue");

 }

 function load() {
  {% for dict in dicts %}
  load_single("{{dict.id}}", "{{dict.pname}}", "{{dict.fragment}}");
  {% endfor %}
 }
</script>
{% endblock %}
{% block body_attributes %}onload="load()"{% endblock %}
{% block content %}
 <h1>Divergence and diversity</h1>
 {% if show_intro %}
  <h4>
   Genetic divergence measures the fraction of genetic sites that have mutated in the viral population from the initial virus. Diversity indicates the fraction of mutated sites within a single viral population.
  </h4>
 {% endif %}
 {% for dict in dicts %}
  <h3>{{dict.name}}</h3>
  <svg class="d3-plot {{dict.id}}"></svg>
 {% endfor %}
 <br>
 
 <h3>Select options:</h3>
 <form role="form" action="" method="post" name="divdiv_settings">
  {{form.hidden_tag()}}
  <div class="form-group">
  <label for="fragments">Fragments</label>
  <p id="fragments">
    F1 {{form.F1}} F2 {{form.F2}} F3 {{form.F3}} F4 {{form.F4}} F5 {{form.F5}} F6 {{form.F6}}
    <br>
  </p>
  </div>
  <div class="form-group">
  <label for="patients">Patients</label>
  <p id="patients">
    p1 {{form.p1}} p2 {{form.p2}} p3 {{form.p3}} p4 {{form.p4}} p5 {{form.p5}} p6 {{form.p6}} p7 {{form.p7}} p8 {{form.p8}} p9 {{form.p9}} p10 {{form.p10}} p11 {{form.p11}}
    <br>
  </p>
  </div>
  <button type="submit" class="btn btn-default">Plot</button>
 </form>
{% endblock %}

