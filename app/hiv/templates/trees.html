{% extends "base.html" %}
{% block head_end %}
 <script src="http://d3js.org/d3.v3.min.js" type="text/javascript"></script>
<script type="text/javascript" src="/static/js/d3.phylogram.js/newick.js"></script>
<script type="text/javascript" src="/static/js/d3.phylogram.js/d3.phylogram.js"></script>
<script>
{% for tree in trees %}
   function load2_{{tree.id}}() {
    d3.json("/treedata/",
      function(error, treejson) {
       update_{{tree.id}}(treejson.newick);
      });
   
   }

   function load3_{{tree.id}}() {
    d3.xhr("/treedata/", "application/json",
      function(request) {
       var treejson = JSON.parse(request.responseText);
       update_{{tree.id}}(treejson.newick);
      }
    );
   }

   function load_{{tree.id}}() {
    d3.xhr("/treedata/")
     .header("Content-Type", "application/json")
     .post(
       JSON.stringify({patient: "{{tree.pname}}", fragment: "{{tree.fragment}}"}),
       function(error, request) {
	var treejson = JSON.parse(request.responseText);
	update_{{tree.id}}(treejson.newick);
       }
    );
   }

   function update_{{tree.id}}(treestr) {
     var newick = Newick.parse(treestr)
     var newickNodes = []
     function buildNewickNodes(node, callback) {
       newickNodes.push(node)
       if (node.branchset) {
         for (var i=0; i < node.branchset.length; i++) {
           buildNewickNodes(node.branchset[i])
         }
       }
     }
     buildNewickNodes(newick)

     if ('{{tree.pname}}' == 'all') {
       var width = 1000
       var height = 2000	
     } else {
       var width = 400
       var height = 300
     }

     d3.phylogram.build('#phylogram_{{tree.id}}', newick, {
       width: width,
       height: height
     });
   }
{% endfor %}

function load() {
   {% for tree in trees %}load_{{tree.id}}();{% endfor %}
}
</script>
{% endblock %}
{% block body_attributes %}onload="load()"{% endblock %}
{% block content %}
 <h1>Phylogenetic trees</h1>
 {% for tree in trees %}
   <h3>{{tree.name}}</h3>
   <div id='phylogram_{{tree.id}}'></div>
 {% endfor %}
 <br>
 
 <hl>Select options:</hl>
 <form action="" method="post" name="tree_settings">
  {{form.hidden_tag()}}
  <p>
    Fragments: F1 {{form.F1}} F2 {{form.F2}} F3 {{form.F3}} F4 {{form.F4}} F5 {{form.F5}} F6 {{form.F6}}
    <!--
    {% for error in form.errors.fragment %}
     <span style="color: red;">[{{error}}]</span>
    {% endfor %}
    -->
    <br>
  </p>
  <p><input type="submit" value="Plot"></p>
 </form>
{% endblock %}
