{% extends "plots.html" %}
{% block head_end %}
{{ super() }}
<script type="text/javascript" src="/static/js/d3.phylogram.js/newick.js"></script>
<script type="text/javascript" src="/static/js/d3.phylogram.js/d3.phylogram.js"></script>
<script>
 function load_single(id, pname, fragment) {
  d3.xhr("/trees/")
   .header("Content-Type", "application/json")
   .post(
     JSON.stringify({patient: pname, fragment: fragment}),
     function(error, request) {
      var treejson = JSON.parse(request.responseText);
      update(treejson.newick, id, pname);
     }
  );
 }

 function update(treestr, id, pname) {
   var newick = Newick.parse(treestr)
   var newickNodes = []
   function buildNewickNodes(node, callback) {
     newickNodes.push(node)
     if (node.branchset) {
       for (var i=0; i < node.branchset.length; i++) {
         buildNewickNodes(node.branchset[i])
       }
     }
   }
   buildNewickNodes(newick)

   if (pname == "all") {
     var width = 600
     var height = 1000	
   } else {
     var width = 400
     var height = 300
   }

   var dict = d3.phylogram.build("#phylogram_"+id, newick, {
     width: width,
     height: height
   });

   dict.vis.selectAll("circle")
    .attr('stroke',  'steelblue')
    .attr('fill', 'steelblue');

 }

 function load() {
  {% for dict in dicts %}
  load_single("{{dict.id}}", "{{dict.pname}}", "{{dict.fragment}}");
  {% endfor %}
 }
</script>
{% endblock %}
{% block body_attributes %}onload="load()"{% endblock %}
{% block content %}
 <h1>Phylogenetic trees</h1>
 {% if show_intro %}
  <h4>
   Phylogenetic trees give a general idea on how similar sequences are. Here we plot trees from consensus sequences from different time points, patients, and parts of the genome. You can specify which trees to display at the bottom of the page.
  </h4>
 {% endif %}
 {% for dict in dicts %}
   <h3>{{dict.name}}</h3>
   <div id='phylogram_{{dict.id}}'></div>
 {% endfor %}
 <br>
 
 <h3>Select options:</h3>
 <form role="form" action="" method="post" name="tree_settings">
  {{form.hidden_tag()}}
  <div class="form-group">
  <label for="fragments">Fragments</label>
  <p id="fragments">
    F1 {{form.F1}} F2 {{form.F2}} F3 {{form.F3}} F4 {{form.F4}} F5 {{form.F5}} F6 {{form.F6}}
    <br>
  </p>
  </div>
  <div class="form-group">
  <label for="patients">Patients</label>
  <p id="patients">
    p1 {{form.p1}} p2 {{form.p2}} p3 {{form.p3}} p4 {{form.p4}} p5 {{form.p5}} p6 {{form.p6}} p7 {{form.p7}} p8 {{form.p8}} p9 {{form.p9}} p10 {{form.p10}} p11 {{form.p11}}
    <br>
  </p>
  </div>
  <button type="submit" class="btn btn-default">Plot</button>
 </form>
{% endblock %}
