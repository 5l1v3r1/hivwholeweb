{% extends "plots.html" %}
{% block head_end %}
{{ super() }}
<script>
 function update(data, id) {

  var margin = {top: 30, right: 30, bottom: 50, left: 80},
      width = 600 - margin.left - margin.right,
      height = 450 - margin.top - margin.bottom;

  var chart_ext = d3.select(".propagator")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.bottom + margin.top);

  var chart = chart_ext.append("g")
       .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var y = d3.scale.log()
       .domain([1e-1, 1e5])
       .range([height, 0]);
  
  var x = d3.scale.linear()
       .domain([-3, 3])
       .range([0, width]);

  // Logit scale (TODO: find out how to do this properly)
  var xx = function(d) {
   return x(Math.log10(d / (1.0 - d)));
  }

  var colors = d3.scale.linear()
  .domain([0, data.HIV.length])
  .interpolate(d3.interpolateRgb)
  .range(["darkblue", "darkred"]);

  var xAxis = d3.svg.axis()
      .scale(x)
      .orient("bottom");
  
  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

  chart.append("g")
       .attr("class", "d3-axis")
       .attr("transform", "translate(0," + height + ")")
       .call(xAxis)
       .append("text")
       .attr("x", width / 2)
       .attr("y", 40)
       .style("text-anchor", "middle")
       .text("Frequency [Logits]");
   
  chart.append("g")
       .attr("class", "d3-axis")
       .call(yAxis)
       .append("text")
       .attr("transform", "rotate(-90)")
       .attr("dy", "-4.5em")
       .attr("x", -height / 2)
       .style("text-anchor", "middle")
       .text("Density");

  var lineFunc = d3.svg.line()
                       .x(function(d) { return d[0]; })
		       .y(function(d) { return d[1]; })
		       .interpolate('monotone');

  function prepareLine(xi) {
   return [[xx(xi), height], [xx(xi), 0]]  
   console.log(prepareLine(xi));
  }

  // TODO: generalize with interactivity
  for(i = 0; i < data.HIV.length; i+= 3) {
   // HIV propagator
   chart.append("g")
        .attr("class", "circles HIV")
        .selectAll()
        .data(data.HIV[i].prop)
        .enter()
        .append("circle")
        .attr("class", "circle")
        .attr("cx", function(d) { return xx(d[0]); })
        .attr("cy", function(d) { return y(d[1]); })
        .attr("r", 5)
        .attr("style", "fill:" + colors(i));

   // Initial frequency
   chart.append("svg:path")
       .attr("d", function(d) { return lineFunc(prepareLine(data.HIV[i].xi)); })
       .attr("stroke", colors(i))
       .attr("stroke-width", 2)
       .attr("fill", "none")
       .attr("opacity", 0.5);

  }


 }

 function load_single() {
  d3.xhr("/propagators/")
   .header("Content-Type", "application/json")
   .post(
     JSON.stringify({test: ""}),
     function(error, request) {
      var data = JSON.parse(request.responseText);
      update(data.data);
     }
  );
 }

 function load() {
  load_single();
 }
</script>
{% endblock %}
{% block body_attributes %}onload="load()"{% endblock %}
{% block content %}
 <h1>{{section_name}}</h1>
 {% if show_intro %}
  <h4>
   Propagator info.
  </h4>
 {% endif %}
 <svg class="d3-plot propagator"></svg>
 <br>

{% endblock %}

