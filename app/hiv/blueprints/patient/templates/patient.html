{% extends "patientPlots.html" %}
{% block head_end %}
{{ super() }}
<link href="../static/css/patient.css" rel="stylesheet">
{% endblock %}
{% block content %}

<div class="container-fluid">
  <!-- sidebar -->
  <div class="col-xs-2 col-sm-2 col-md-2 col-lg-2 patient-sidebar">
    <div class="panel panel-default" style="width:110px; text-align:center">
      <div class="panel-heading">
        <span class="glyphicon glyphicon-user"></span> Patients
      </div>
      <div class="list-group">
        {% for ptmp in pnames %}
        {% if ptmp == pname and ptmp!='p4'%} <!-- exclude p4 -->
  	<a href="/patient/{{ptmp}}" class="list-group-item active">{{ptmp}}</a>
        {% elif ptmp!='p4' %} <!-- exclude p4 -->
        <a href="/patient/{{ptmp}}" class="list-group-item">{{ptmp}}</a>
        {% endif %}
        {% endfor %}
      </div> 
    </div>
  </div>
  <div class="clearfix visible-xs"></div>
  <!-- patient content -->
  <div class="col-xs-10 col-sm-10 col-md-10 col-lg-10 patient-content">
    <!-- flashed messages -->
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="alert alert-danger" role="alert">
      {% for message in messages %}
      <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
      <span class="sr-only">Error: </span>{{ message }}
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <!-- end flashed messages -->
    <!-- header -->
    <div class="panel panel-default">
      <div class="panel-body text-primary" style="text-align:center">
        <h4><span class="glyphicon glyphicon-user"></span> Patient {{pname}}</h4>
      </div>
    </div>
    <!-- already expanded panels --> 
    <div class="panel-group">
      <!-- Intro -->
      <div class="panel panel-default">
        <div class="panel-heading"> 
        <span class="text-primary glyphicon glyphicon-question-sign"></span> &nbsp;<a data-toggle="collapse" href="#Intro">Introduction</a>
        </div>
        <div id="Intro" class="panel-collapse collapse in">
          <div class="panel-body" style="text-align:justify">
          <!-- Intro text -->  
	  {% include ["snippets/intro_"+pname+".html", "snippets/intro.html"] ignore missing %}
          </div>
        </div>
      </div>
      <!-- Summary -->
      <div class="panel panel-default">
        <div class="panel-heading"> 
        <span class="text-primary text-primary glyphicon glyphicon-info-sign"></span> &nbsp;<a data-toggle="collapse" href="#Sum">Summary</a>
        </div>
      <div id="Sum" class="panel-collapse collapse in">
        <div class="panel-body">
        <!-- Summary content -->
          <div class="row">
  	  <div class="col-xs-6">
              <dl class="dl-horizontal">
                {% for row in patientTable %}
                {% if row['Patient'] == pname %}
                <dt>subtype</dt><dd>{{row['Subtype']}}</dd>
                <dt>&#35; samples</dt><dd>{{row['# samples']}}</dd>
                {% endif %}
                {% endfor %}
              </dl>
  	    <!-- SAMPLE TABLE -->
              <table class="table">
                <thead>
                  <tr>
  	          <th>Time</th>
                    <th colspan="6" align="center">Estimated number of RNA templates per PCR</th>
                  </tr>
  	        <tr>
  	          <th>[days since infection]</th>
                    <th>F1</th>
                    <th>F2</th>
                    <th>F3</th>
                    <th>F4</th>
                    <th>F5</th>
                    <th>F6</th>
  	        </tr>
                </thead>
                <tbody>
  	        {% for row in sampleTable %}
                  <tr>
  	          <td>{{row.time}}</td>
  	          <td>{{row.F1q}}</td>
  	          <td>{{row.F2q}}</td>
  	          <td>{{row.F3q}}</td>
  	          <td>{{row.F4q}}</td>
  	          <td>{{row.F5q}}</td>
  	          <td>{{row.F6q}}</td>
  	        </tr>
  	        {% endfor %}
                </tbody>
              </table>
  	    <!-- END SAMPLE TABLE -->
            </div>
  	  <div class="col-xs-6">
  	   <p align="center">Phylogenetic tree of <b>V3</b> in patient {{pname}}.
  	   <!-- <svg id='treeSvg{{pname}}Sum'></svg> -->
  	   <img src='/static/data/trees/tree_{{pname}}_V3_example.svg' style="max-width:100%; max-height:100%">
            </div>
          </div>
        </div>
      </div>
     </div>    
     <!-- expand nav -->
     <div class="panel panel-default"> 
        <div class="panel-heading">
           <img width="18" src="../../static/images/icons/viral_load.svg"> 
           <a data-toggle="collapse" data-parent="#expand" href="#viral">Viral load and CD4+ counts</a>
        </div>
        <div id="viral" class="panel-collapse collapse in">
          <div class="panel-body">
            <svg class="d3-plot" id="physioSvg{{pname}}"></svg>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
          <img width="18" src="../../static/images/icons/genome.svg"> 
          <a data-toggle="collapse" data-parent="#expand" href="#genome">Genome sequence</a>
        </div>
        <div id="genome" class="panel-collapse collapse in">
          <div class="panel-body">
            <svg class="d3-plot" id="genomeSvg{{pname}}"></svg>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
          <img width="18" src="../../static/images/icons/tree.svg"> 
          <a data-toggle="collapse" data-parent="#expand" href="#tree">Phylogenetic trees</a>
        </div>
        <div id="tree" class="panel-collapse collapse">
          <div class="panel-body">
            <div style="padding-bottom:20px">
              <svg class="d3-plot" id='treeSvg{{pname}}'></svg>
            </div>
            <div class="form-group form-inline" align="center">
             <label>Region:</label>
             <select class="form-control treeRegion">
               {% for region in treeRegions %}
                <option>{{region}}</option>
               {% endfor %} 
             </select>
            </div>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
           <img width="18" src="../../static/images/icons/diversity.svg">
           <a data-toggle="collapse" data-parent="#expand" href="#divDiv">Genetic divergence and diversity</a>
        </div>
        <div id="divDiv" class="panel-collapse collapse">
          <div class="panel-body">
            <div style="padding-bottom:20px">
              <svg class="d3-plot" id='divDivSvg{{pname}}'></svg>
            </div>
            <div class="form-group form-inline" align="center">
             <label>Region:</label>
             <select class="form-control divDivRegion">
               {% for region in divDivRegions %}
                <option>{{region}}</option>
               {% endfor %} 
             </select>
            </div>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
           <img width="18" src="../../static/images/icons/divdiv_local.svg">
           <a data-toggle="collapse" data-parent="#expand" href="#divDivLocal">Local divergence and diversity</a>
         </div>
        <div id="divDivLocal" class="panel-collapse collapse">
          <div class="panel-body">
            <svg class="d3-plot" id='divDivLocalSvg{{pname}}'></svg>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
           <img width="18" src="../../static/images/icons/coverage.svg">
           <a data-toggle="collapse" data-parent="#expand" href="#cov">Coverage</a>
         </div>
        <div id="cov" class="panel-collapse collapse">
          <div class="panel-body">
            <svg class="d3-plot" id='coverageSvg{{pname}}' height="600"></svg>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
           <img width="18" src="../../static/images/icons/allele_frequencies.svg">
           <a data-toggle="collapse" data-parent="#expand" href="#allFreq">Allele frequencies</a>
         </div>
        <div id="allFreq" class="panel-collapse collapse">
          <div class="panel-body">
            <svg class="d3-plot" id='allFreqSvg{{pname}}' height="700"></svg>
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
          <img width="18" src="../../static/images/icons/consensi.svg"> 
          <a data-toggle="collapse" data-parent="#expand" href="#consensus">Consensus sequences</a>
        </div>
        <div id="consensus" class="panel-collapse collapse">
          <div class="panel-body">
            consensus sequences
          </div>
        </div>
      </div>
      <div class="panel panel-default"> 
        <div class="panel-heading">
           <img width="18" src="../../static/images/icons/haplotype_frequencies.svg">
           <a data-toggle="collapse" data-parent="#expand" href="#haplo">Local haplotypes</a>
          </div>
        <div id="haplo" class="panel-collapse collapse">
          <div class="panel-body">
            <div class="row">
              <div class="col-md-6">
                <div class="thumbnail">
                  <h4>Precompiled alignments</h4>
                  <p>These alignments are premade for regions of general interest.</p>
                  <div class="svg-container">
                    <svg id="haploThumbnail" width=400 height=70></svg>
                  </div>
                  <form role="form" action="" method="post" name="haplo_precompiled" style="padding-bottom:10px">
                    <div class="form-group">
                      {{formpc.hidden_tag()}}
                      {{formpc.region.label}}
                      {{formpc.region}}
                    </div>
                    <button type="submit" class="btn btn-default">Download</button>
                  </form>
                </div>
              </div>
              <div class="col-md-6">
                <div class="thumbnail">
                  <h4>New alignments</h4>
                  <p>Generate alignments for a custom genomic region.</p>
                  <form role="form" action="" method="post" name="haplo_settings" style="padding:10px">
                    {{form.roi.hidden_tag()}}
                    <div class="form-group">
                      {{form.roi.start.label}}
                      {{form.roi.start}}
                      {{form.roi.end.label}}
                      {{form.roi.end}}
                    </div>
                    <p><b>From</b>/<b>To</b> require <b>HXB2</b> coordinates (both ends included).</p>
                    <p><b>NOTE</b>: A few <b>minutes</b> might elapse while we prepare your data.</p>
                    <button type="submit" class="btn btn-default">Generate</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Scripts at the end of page load -->
<script type="text/javascript" src="/static/js/physio.js"></script>
<script type="text/javascript">
function loadPhysio(id, pname) {
 d3.xhr("/method/physiological/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname}),
    function(error, request) {
     var data = JSON.parse(request.responseText);
     updatePhysio(id, data.data);
    }
 );
}
</script>

<script type="text/javascript" src="/static/js/genome.js"></script>
<script type="text/javascript">
function loadGenome(id, pname) {
    d3.xhr("/method/genomes/")
   .header("Content-Type", "application/json")
   .post(
     JSON.stringify({patient: pname}),
     function(error, request) {
      var data = JSON.parse(request.responseText);
      data = {pname: pname, genome: data.data};
      updateGenome(id, data);
     }
  );
}
</script>

<script type="text/javascript" src="/static/js/trees.js"></script>
<script type="text/javascript">
function loadTree(id, pname, region) {
 d3.xhr("/method/trees/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname, region: region, treeFormat: "json"}),
    function(error, request) {
     var data = JSON.parse(request.responseText);
     d3.json(data.tree, function(error, tree) {
      data.pname = pname;
      data.region = region;
      data.tree = tree;      
      updateTree(id, data);
     });     
    });
}
</script>

<script type="text/javascript" src="/static/js/divdiv.js"></script>
<script type="text/javascript">
function loadDivDiv(id, pname, region) {
 d3.xhr("/method/divdiv/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname, region: region}),
    function(error, request) {
     var data = JSON.parse(request.responseText);
     updateDivDiv(id, data.data);
    }
 );
}
</script>

<script type="text/javascript" src="/static/js/divdiv_local.js"></script>
<script type="text/javascript">
function loadDivDivLocal(id, pname) {
 d3.xhr("/method/divdiv_local/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname}),
    function(error, request) {
     var data_dd = JSON.parse(request.responseText);

     d3.xhr("/method/genomes/")
     .header("Content-Type", "application/json")
     .post(
       JSON.stringify({patient: pname}),
       function(error, request) {
        var data_gn = JSON.parse(request.responseText);
        var data = {"divdiv": data_dd.data, "genome": data_gn.data};
        updateDivDivLocal(id, data);
       }
     );

    }
 );
}
</script>

<script type="text/javascript" src="/static/js/coverage.js"></script>
<script type="text/javascript">
function loadCoverage(id, pname) {
 d3.xhr("/method/coverage/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname}),
    function(error, request) {
     var data = JSON.parse(request.responseText);

     d3.xhr("/method/genomes/")
     .header("Content-Type", "application/json")
     .post(
       JSON.stringify({patient: pname}),
       function(error, request) {
        var data_gn = JSON.parse(request.responseText);

        d3.xhr("/method/n_templates/")
         .header("Content-Type", "application/json")
         .post(
           JSON.stringify({patient: pname}),
           function(error, request) {
            var data_ntemplates = JSON.parse(request.responseText);

            // This is not totally safe, but ok for now
            data = data.data;
            data.genome = data_gn.data;
            data.ntemplates = data_ntemplates.data.ntemplates;
            updateCoverage(id, data);
         });
      });
   });
}
</script>

<script type="text/javascript" src="/static/js/allele_frequencies.js"></script>
<script type="text/javascript">
function loadAlleleFrequencies(id, pname) {
 d3.xhr("/method/allele_frequencies/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname}),
    function(error, request) {
     var data = JSON.parse(request.responseText);

     d3.xhr("/method/genomes/")
     .header("Content-Type", "application/json")
     .post(
       JSON.stringify({patient: pname}),
       function(error, request) {
        var data_gn = JSON.parse(request.responseText);


        d3.xhr("/method/n_templates/")
          .header("Content-Type", "application/json")
          .post(
            JSON.stringify({patient: pname}),
            function(error, request) {
             var data_ntemplates = JSON.parse(request.responseText);

             // This is not totally safe, but ok for now
             data = data.data;
             data.genome = data_gn.data;
             data.ntemplates = data_ntemplates.data.ntemplates;
             updateAlleleFrequencies(id, data);
          });
       });
    });
}
</script>


<!-- load at page opening -->
<script>
loadTree("treeSvg{{pname}}Sum", "{{pname}}", "V3");
loadPhysio("physioSvg{{pname}}", "{{pname}}");
loadGenome("genomeSvg{{pname}}", "{{pname}}");
</script>


<!-- collapsible event handling -->
<script type="text/javascript">
$('#viral').on('shown.bs.collapse', function () {
    loadPhysio("physioSvg{{pname}}", "{{pname}}");
})
$('#viral').on('hidden.bs.collapse', function () {
    emptyPhysio("physioSvg{{pname}}");
})

$('#genome').on('shown.bs.collapse', function () {
    loadGenome("genomeSvg{{pname}}", "{{pname}}");
})
$('#genome').on('hidden.bs.collapse', function () {
    emptyGenome("genomeSvg{{pname}}");
})

$('#tree').on('shown.bs.collapse', function () {
    var region = $('.treeRegion option:selected').val();
    loadTree("treeSvg{{pname}}", "{{pname}}", region);
})
$('#tree').on('hidden.bs.collapse', function () {
    emptyTree("treeSvg{{pname}}");
})

$('#divDiv').on('shown.bs.collapse', function () {
    var region = $('.divDivRegion option:selected').val();
    loadDivDiv("divDivSvg{{pname}}", "{{pname}}", region);
})
$('#divDiv').on('hidden.bs.collapse', function () {
    emptyDivDiv("divDivSvg{{pname}}");
})

$('#divDivLocal').on('shown.bs.collapse', function () {
    loadDivDivLocal("divDivLocalSvg{{pname}}", "{{pname}}");
})
$('#divDivLocal').on('hidden.bs.collapse', function () {
    emptyDivDivLocal("divDivLocalSvg{{pname}}");
})

$('#cov').on('shown.bs.collapse', function () {
    loadCoverage("coverageSvg{{pname}}", "{{pname}}");
})
$('#cov').on('hidden.bs.collapse', function () {
    emptyCoverage("coverageSvg{{pname}}");
})

$('#allFreq').on('shown.bs.collapse', function () {
    loadAlleleFrequencies("allFreqSvg{{pname}}", "{{pname}}");
})
$('#allFreq').on('hidden.bs.collapse', function () {
    emptyAlleleFrequencies("allFreqSvg{{pname}}");
})

</script>

<!-- jquery event handling for selections (trees, etc) -->
<script>
$('select.treeRegion').on('change', function(){
   var region = $('.treeRegion option:selected').val();
   loadTree("treeSvg{{pname}}", "{{pname}}", region);
});

$('select.divDivRegion').on('change', function(){
   var region = $('.divDivRegion option:selected').val();
   loadDivDiv("divDivSvg{{pname}}", "{{pname}}", region);
});

</script>

<script type="text/javascript" src="/static/js/haplo.js"></script>
<script type="text/javascript">
function loadHaplo(id, pname) {
    d3.xhr("/method/genomes/")
        .header("Content-Type", "application/json")
        .post(
          JSON.stringify({patient: pname}),
          function(error, request) {
           var data = JSON.parse(request.responseText);
           updateHaplo(id, {'data': data.data, 'pname': pname});
          });
}
loadHaplo("haploThumbnail", "HXB2");

$('#region').change(function() {
 $("#region option:selected").each(function() {
  moveRegion($(this).text());
 });
});
</script>



<!-- NOTE: the tag below is a trick for the tree plot -->
<div id="switchRectangular" class="active"></div>
{% endblock %}
