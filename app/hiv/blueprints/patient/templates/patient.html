{% extends "patientPlots.html" %}
{% block content %}

<div class="container-fluid" style="padding:20px">

<!-- sidebar -->
<div class="col-xs-2 col-sm-2 col-md-2 col-lg-2">

  <div class="panel panel-default" style="width:110px; text-align:center">
		<div class="panel-heading">
      <b class="text-primary"><span class="glyphicon glyphicon-user"></span> Patients</b>
    </div>
		<div class="list-group">
        {% for ptmp in pnames %}
        {% if ptmp == pname and ptmp!='p4'%} <!-- exclude p4 -->
	      <a href="/patient/{{ptmp}}" class="list-group-item active">{{ptmp}}</a>
        {% elif ptmp!='p4' %} <!-- exclude p4 -->
        <a href="/patient/{{ptmp}}" class="list-group-item">{{ptmp}}</a>
        {% endif %}
        {% endfor %}
    </div> 
  </div>

</div>

<div class="clearfix visible-xs"></div>

<!-- patient content -->
<div class="col-xs-10 col-sm-10 col-md-10 col-lg-10">

  <!-- header -->
  <div class="panel panel-default">
    <div class="panel-body text-primary" style="text-align:center">
      <h4><span class="glyphicon glyphicon-user"></span> <b>{{pname}}</b></h4>
    </div>
  </div>
  <!-- already expanded panels --> 
  <div class="panel-group">
    <!-- Intro -->
    <div class="panel panel-default">
      <div class="panel-heading"> 
      <span class="text-primary glyphicon glyphicon-question-sign"></span> &nbsp;<a data-toggle="collapse" href="#Intro">Introduction</a>
      </div>
      <div id="Intro" class="panel-collapse collapse in">
        <div class="panel-body" style="text-align:justify">
        <!-- Intro text -->  
		        text  
        </div>
      </div>
    </div>
    <!-- Summary -->
    <div class="panel panel-default">
      <div class="panel-heading"> 
      <span class="text-primary text-primary glyphicon glyphicon-info-sign"></span> &nbsp;<a data-toggle="collapse" href="#Sum">Summary</a>
      </div>
    <div id="Sum" class="panel-collapse collapse in">
      <div class="panel-body">
      <!-- Summary content -->
        <div class="row">
		      <div class="col-xs-6">
            <!-- div 1 -->
            <dl class="dl-horizontal">
              {% for row in patientTable %}
              {% if row['Patient'] == pname %}
              <dt>subtype</dt><dd>{{row['Subtype']}}</dd>
              <dt>&#35; samples</dt><dd>{{row['# samples']}}</dd>
              <dt>1st sample [days]</dt><dd>{{row['1st sample']}}</dd>
              <dt>last sample [days]</dt><dd>{{row['last sample']}}</dd>
              {% endif %}
              {% endfor %}
            </dl>      
          </div>
	  <div class="col-xs-6">
            <svg class="d3-plot" id="genomeSvg{{pname}}Sum"></svg>
          </div>
        </div>
        <div class="row">
          <div class="col-xs-6">
            <svg class="d3-plot" id="physioSvg{{pname}}Sum"></svg>
          </div>
          <div class="col-xs-6">
            <svg id='treeSvg{{pname}}Sum'></svg>
          </div>
        </div>
      </div>
    </div>
   </div>    
   <!-- expand nav -->
   <div class="panel panel-default"> 
      <div class="panel-heading">
         <img width="18" src="../../static/images/icons/viral_load.svg"> 
         <a data-toggle="collapse" data-parent="#expand" href="#viral">Viral load and CD4+ counts</a>
      </div>
      <div id="viral" class="panel-collapse collapse in">
        <div class="panel-body">
          <svg class="d3-plot" id="physioSvg{{pname}}"></svg>
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
        <img width="18" src="../../static/images/icons/genome.svg"> 
        <a data-toggle="collapse" data-parent="#expand" href="#genome">Genome sequence</a>
      </div>
      <div id="genome" class="panel-collapse collapse in">
        <div class="panel-body">
          <svg class="d3-plot" id="genomeSvg{{pname}}"></svg>
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
        <img width="18" src="../../static/images/icons/tree.svg"> 
        <a data-toggle="collapse" data-parent="#expand" href="#tree">Phylogenetic trees</a>
      </div>
      <div id="tree" class="panel-collapse collapse in">
        <div class="panel-body">
          <svg class="d3-plot" id='treeSvg{{pname}}'></svg>
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
         <img width="18" src="../../static/images/icons/diversity.svg">
         <a data-toggle="collapse" data-parent="#expand" href="#geneticdiv">Genetic divergence and diversity</a>
       </div>
      <div id="geneticdiv" class="panel-collapse collapse">
        <div class="panel-body">
          divergence and diversity
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
         <img width="18" src="../../static/images/icons/divdiv_local.svg">
         <a data-toggle="collapse" data-parent="#expand" href="#localdiv">Local divergence and diversity</a>
       </div>
      <div id="localdiv" class="panel-collapse collapse">
        <div class="panel-body">
          local divergence and diversity
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
         <img width="18" src="../../static/images/icons/coverage.svg">
         <a data-toggle="collapse" data-parent="#expand" href="#cov">Coverage</a>
       </div>
      <div id="cov" class="panel-collapse collapse">
        <div class="panel-body">
          coverage
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
         <img width="18" src="../../static/images/icons/allele_frequencies.svg">
         <a data-toggle="collapse" data-parent="#expand" href="#freq">Allele frequencies</a>
       </div>
      <div id="freq" class="panel-collapse collapse">
        <div class="panel-body">
          allele frequencies
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
        <img width="18" src="../../static/images/icons/consensi.svg"> 
        <a data-toggle="collapse" data-parent="#expand" href="#consensus">Consensus sequences</a>
      </div>
      <div id="consensus" class="panel-collapse collapse">
        <div class="panel-body">
          consensus sequences
        </div>
      </div>
    </div>
    <div class="panel panel-default"> 
      <div class="panel-heading">
         <img width="18" src="../../static/images/icons/haplotype_frequencies.svg">
         <a data-toggle="collapse" data-parent="#expand" href="#haplo">Local haplotypes</a>
        </div>
      <div id="haplo" class="panel-collapse collapse">
        <div class="panel-body">
          local haplotypes
        </div>
      </div>
    </div>
  </div>
</div>

</div>

<!-- Scripts at the end of page load -->
<script type="text/javascript" src="/static/js/genome.js"></script>
<script type="text/javascript">
function loadGenome(id, pname, callback) {
    d3.xhr("/method/genomes/")
   .header("Content-Type", "application/json")
   .post(
     JSON.stringify({patient: pname}),
     function(error, request) {
      var data = JSON.parse(request.responseText);
      data = {pname: pname, genome: data.data};
      callback(id, data);
     }
  );
}

loadGenome("genomeSvg{{pname}}Sum", "{{pname}}", updateGenome);
loadGenome("genomeSvg{{pname}}", "{{pname}}", updateGenome);
</script>

<script type="text/javascript" src="/static/js/physio.js"></script>
<script type="text/javascript">
function loadPhysio(id, pname, callback) {
 d3.xhr("/method/physiological/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname}),
    function(error, request) {
     var data = JSON.parse(request.responseText);
     callback(id, data.data);
    }
 );
}

loadPhysio("physioSvg{{pname}}Sum", "{{pname}}", updatePhysio);
loadPhysio("physioSvg{{pname}}", "{{pname}}", updatePhysio);
</script>

<script type="text/javascript" src="/static/js/trees.js"></script>
<script type="text/javascript">
function loadTree(id, pname, region, callback) {
 d3.xhr("/method/trees/")
  .header("Content-Type", "application/json")
  .post(
    JSON.stringify({patient: pname, region: region, treeFormat: "json"}),
    function(error, request) {
     var data = JSON.parse(request.responseText);
     data.pname = pname;
     data.region = region;

     var treefn = data.tree;

     d3.json(treefn, function(error, tree) {
      data.tree = tree;      
      callback(id, data);
     });     
    });
}

loadTree("treeSvg{{pname}}Sum", "{{pname}}", "V3", updateTree);
loadTree("treeSvg{{pname}}", "{{pname}}", "V3", updateTree);
</script>

<!-- NOTE: the tag below is a trick for the tree plot -->
<div id="switchRectangular" class="active"></div>
{% endblock %}
