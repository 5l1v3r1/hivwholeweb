{% extends "base.html" %}
{% block content %}
<div class="container" style="padding:20px">
  <!-- flashed messages -->
  {% with messages = get_flashed_messages() %}
  {% if messages %}
  <div class="alert alert-danger" role="alert">
    {% for message in messages %}
    <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
    <span class="sr-only">Error: </span>{{ message }}
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}
  <!-- end flashed messages -->

<!-- header -->
<div class="panel header-panel">
    <div class="panel-body">
      <h4 class="pagetitle"><span class="glyphicon glyphicon-download-alt"></span> Data access</h4>
  </div>
</div>
<!-- content -->  
<div class="panel tab-panel">
  <div class="panel-heading tab bottom-border"> 
    Introduction
</div>
<div class="text-explanation">
    {% include "snippets/introData.html" ignore missing %}
</div>
</div>
<div class="panel tab-panel">
  <div class="panel-heading tab bottom-border"> 
    Clinical and summary data
</div>
<div class="panel-body">
    <table class="table">
      <thead>
        <tr>
          <th>Patient</th>
          <th>Samples</th>
          <th>Time of infection</th>
          <th>Viral load</th>
          <th>CD4+ counts</th>
          <th>HLA type</th>
          <th>Reference</th>
          <th>SNV counts</th>
      </tr>
  </thead>
  <tbody>
     {% for datum in data %}
     <tr>
       <td>{{datum.pname}}</td>
       <td>{{datum.nsamples}}</td>
       <td><a href="{{datum.ToI}}">csv</a></td>
       <td><a href="{{datum.vl}}">DAT</a></td>
       <td><a href="{{datum.cd4}}">DAT</a></td>
       <td><a href="{{datum.HLA}}">csv</a></td>
       <td><a href="{{datum.refgb}}">GB</a> | <a href="{{datum.reffa}}">Fasta</a></td>
       <td><a href="{{datum.act}}">ZIP</a></td>
   </tr>
   {% endfor %}
</tbody>
</table>
</div>
<div class='text-explanation'>
   {% include "snippets/summaryData.html" ignore missing %}
</div>
</div>
<div class="panel tab-panel">
    <div class="panel-heading tab bottom-border"> 
      Haplotypes
  </div>
  <div class="panel-body">
      <div class="col-md-5">
        <div class="thumbnail">
          <h4>Precompiled alignments</h4>
          <p>These alignments are premade for regions of general interest.</p>
          <div class="svg-container">
             <svg id="haploThumbnail" width=400 height=70></svg>
         </div>
         <form role="form" action="" method="post" name="haplo_precompiled" style="padding-bottom:10px">
          <div class="form-group">
            {{formpc.hidden_tag()}}
            {{formpc.patient.label}}
            {{formpc.patient}}
            {{formpc.region.label}}
            {{formpc.region}}
        </div>
        <button type="submit" class="btn btn-default">Download</button>
    </form>
</div>
</div>
<div class="col-md-7">
  <div class="thumbnail">
    <h4>New alignments</h4>
    <p>Generate alignments for a custom genomic region.</p>
    <form role="form" action="" method="post" name="haplo_settings" style="padding:10px">
      {{form.hidden_tag()}}
      {{form.roi.hidden_tag()}}
      <div class="form-group">
        {{form.patient.label}}
        {{form.patient}}
        {{form.roi.start.label}}
        {{form.roi.start}}
        {{form.roi.end.label}}
        {{form.roi.end}}
    </div>
    <p><b>From</b>/<b>To</b> require <b>HXB2</b> coordinates (both ends included).</p>
    <p><b>NOTE</b>: A few <b>minutes</b> might elapse while we prepare your data.</p>
    <button type="submit" class="btn btn-default">Generate</button>
</form>
</div>
</div>
<!-- put continuous text here if you need full width of haplo div -->
</div>
</div>
<div class="panel tab-panel">
    <div class="panel-heading tab"> 
      <a data-toggle="collapse" href="#raw">Sequencing Reads</a>
  </div>
  <div id="raw" class="panel-collapse collapse in">
      <div class="panel-body">

        <!-- tab design draft for read data -->
        <ul class="nav nav-tabs">
           {% for datum in data %}
           {% if datum.pname == "p1" %}
           <li class="active"><a data-toggle="tab" href="#reads{{datum.pname}}">{{datum.pname}}</a></li>
           {% else %}
           <li><a data-toggle="tab" href="#reads{{datum.pname}}">{{datum.pname}}</a></li>
           {% endif %}
           {% endfor %}
       </ul> 

       <div class="tab-content">
           <!-- need for a jinja for cycle over the patients -->
           {% for datum in data %}
           {% if datum.pname == "p1" %}
           <div id="reads{{datum.pname}}" class="tab-pane fade in active">
             {% else %}
             <div id="reads{{datum.pname}}" class="tab-pane fade">
               {% endif %}
               <table class="table">
                  <thead>
                    <tr>
                      <th>Sample</th>
                      <th colspan="6" align="center">PCR amplicon</th>
                  </tr>
                  <tr>
                   <th>[days since infection]</th>
                   <th>F1</th>
                   <th>F2</th>
                   <th>F3</th>
                   <th>F4</th>
                   <th>F5</th>
                   <th>F6</th>
               </tr>
           </thead>
           <tbody>
              {% for sample in datum.reads %}
              {% set sampleloop = loop %}
              <tr>
                <td>{{sample.time}}</td>
                {% for fr in fragments %}
                <td>
                  {% if sample.get(fr) %}
                  <a href="/download/reads_{{datum.pname}}_{{sampleloop.index}}_{{fr}}.bam">BAM</a></td>
                  {% else %}
                  -
                  {% endif %}
              </td>
              {% endfor %}
          </tr>
          {% endfor %}
      </tbody>
  </table>

</div>
{% endfor %}
</div>
<div class="text-explanation">
</div>
</div>
</div>
</div>
</div>

<!-- JavaScript loading at the end to not slow down page load -->
<script type="text/javascript" src="/static/js/haplo.js"></script>
<script type="text/javascript">
  function loadHaplo(id, pname) {
    d3.xhr("/method/genomes/")
    .header("Content-Type", "application/json")
    .post(
          JSON.stringify({patient: pname}),
          function(error, request) {
             var data = JSON.parse(request.responseText);
             updateHaplo(id, {'data': data.data, 'pname': pname});
         });
}
loadHaplo("haploThumbnail", "HXB2");

$('#region').change(function() {
 $("#region option:selected").each(function() {
    moveRegion($(this).text());
});
});
</script>

{% endblock %}
